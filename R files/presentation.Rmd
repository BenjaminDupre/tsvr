---
title: "TSVR"
author: " "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')
########## Loading Domains
library(ez) # for anovas
library(ggplot2) # in every graph
library(plyr) # for building the rt graph
library(lme4) # to test difference in accuracy
library(lmerTest) # to test Now approx p-val w/Kenward-Roger’s approximations
library(gridBase) # its used to mixed the graphics together base and ggplot
library(grid) # its used to mixed the graphics together base and ggplot
########## Defining Working Folder
setwd('/Users/calypso/Dropbox/My Mac (glaroam2-185-117.wireless.gla.ac.uk)/Documents/Research MaxPlank/P1_propioception/R_tsvr_presentation/data/')
##########Loading File
tsvr <- read.table('responsetime.csv',header=T,sep = ',',dec = '.') # this is the file saved from the matlab file 
tsvr2 <- read.table('behavioral_a.csv', header=T,sep = ',',dec = '.')
########## Running ANOVA for RT
tsvr$stimulus <- factor(tsvr$stimulus, levels = c(3, 2, 1))
tsvr$stimulus <-revalue(tsvr$stimulus, c("3"="base", "2"="Incongruent", "1"="Congruent"))
tsvr$ptcp <- factor(tsvr$ptcp)
# tsvr$lvl <- factor(tsvr$lvl)
# tsvr$set <- factor(tsvr$set)
data_summary <- function(data, varname, grps){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, grps, .fun=summary_func, varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

```
The following dataset used in the analysis counts with a variable number for participants (ptcp), a variable number for the 'set,' which refers to one of the three chunks of uninterrupted trails and a variable called level ('lvl') assigned each of the 36-trials presented per set.

The variable 'start' corresponds to the moment the ball is placed in the hand of the participant. The number represents the row position in the original raw data. Likewise, 'end' corresponds to the explosion of the board and it also represents a row position in the original raw data. 

The variable 'accuracy' takes value 1 when there is a mistake 0 otherwise.

The variable 'diff' refers to the time difference between 'start' and 'end', expressed in seconds and to finalize the categorical variable 'stimulus' signals whether the participant felt the vibration on the same hand the see the ball placed or not.

There are some trails being left out due to participants taking longer than 6 seconds to answer, when placed the ball not being recognized, or if there was a ezPlotdata glove failure.  

```{r tsvr, echo=TRUE}
summary(tsvr)
```

**1. Testing time difference between conditions withing subjects (base, congruent, incongruent).**

a.- With the aggregated data, partially cleaned, we run an ANOVA to test for response time difference between stimuli groups. I was not familiar with this package, which Esra suggested and it runs easily within subjects ANOVAS. The results show significant difference between groups: 

*diff is not a normally distributed variable, ANOVA can handle this*

```{r, echo=TRUE, warning=FALSE}
output_anova = ezANOVA(data = tsvr,
        dv = .(diff),
        wid = .(ptcp),
        within = .(stimulus),
        within_covariates = .(set),
        detailed = T,
        type=3)

print(output_anova)
```

b.- The slowest condition is the only visual condition, followed by the congruent visuo-haptic condition and the slowest condition is the incongruent visuo-haptic. 

The estimated effect size is very small, although significant. (E.g. mean difference between base and incongruent visual-haptic condition is 53 milliseconds. The standard deviation is 600 milliseconds. 


```{r, echo=FALSE, fig.align = "center",  warning=FALSE}

rt <- ezPlot(data = tsvr,
         dv = diff,
         wid = ptcp,
         within = .(stimulus),
         within_covariates = set,
         x = .(stimulus))
rt = rt + labs(title ="Response Time per Condition", x = "Visual - Heptic Stimuli", y = "(mean in seconds)") + 
      theme(
        panel.grid.major.y = element_line(colour = "gray80", size = NULL, linetype = NULL,  
                                          lineend = NULL)
        ,panel.grid.minor.y = element_line(colour = "gray90", size = NULL, linetype = NULL,
                                           lineend = NULL)
        ,panel.grid.major.x = element_blank()           
        ,panel.grid.minor.x = element_blank()
        ,legend.background = element_rect(fill = NULL, colour = "black") 

        ,panel.background = element_rect(fill = "white", colour = "white", size = NULL, 
                                         linetype = NULL))
rt
```

**2. Testing for accuracy difference between conditions withing subjects (base, congruent, incongruent).**

a.- We are to consider whether congruent, incongruent and base conditions play any significant roll on the mistake’s behaviour shown by participants when placing the ball on the memorised spot. 

Since we have defined the variable as binary dependant one (0 if correct 1 if incorrect) we run linear mixed effect model using the participants variable as random effects. 

The model shows no significant difference between the mistake rate between categories. Mistakes only show significant results for response time variable, although the effect size is small. It would not seem relevant for our proposes because it is not our manipulated variable.

```{r , echo=FALSE, fig.align = "center", warning=FALSE}
########## ANOVA for ACCURACY
fm1<- lmer(accuracy ~ stimulus + (1 | ptcp) , data= tsvr)
summary(fm1)

acc <- ezPlot(data = tsvr,
              dv = accuracy,
              wid = ptcp,
              within = .(stimulus),
              within_covariates = set,
              x = .(stimulus),
              type = 3)
acc <- acc + labs(title ="Innacuracy per Condition", x = "Visual - Heptic Stimuli ", y = " proportion of mistakes over total") + 
  theme(
    panel.grid.major.y = element_line(colour = "gray80", size = NULL, linetype = NULL,  
                                      lineend = NULL)
    ,panel.grid.minor.y = element_line(colour = "gray90", size = NULL, linetype = NULL,
                                       lineend = NULL)
    ,panel.grid.major.x = element_blank()           
    ,panel.grid.minor.x = element_blank()
    ,legend.background = element_rect(fill = NULL, colour = "black") 
    
    ,panel.background = element_rect(fill = "white", colour = "white", size = NULL, 
                                     linetype = NULL)
        )
acc
```

**3. Testing for IBI difference between conditions withing subjects (base, congruent, incongruent).**
```{r, include=FALSE}
setwd('/Users/calypso/Dropbox/My Mac (glaroam2-185-117.wireless.gla.ac.uk)/Documents/Research MaxPlank/P1_propioception/R_tsvr_presentation/data/')
tsvr2 <- read.table('behavioral_a.csv', header=T,sep = ',',dec = '.')
tsvr2 <- tsvr2[!(tsvr2$ptcp== 2 |tsvr2$ptcp== 3 | tsvr2$ptcp == 13 | tsvr2$ptcp == 11),]
tsvr2$stimulus <- factor(tsvr2$stimulus, levels = c(3, 2, 1))
tsvr2$stimulus <-revalue(tsvr2$stimulus, c("3"="base", "2"="Incongruent", "1"="Congruent"))
tsvr2<- na.omit(tsvr2)
```

a.- Inter beat intervals where detected using Hooman Sedghamiz (2018) algrithm. I consider the two seconds after the vibrations starts. The analysis was run without getting into detail of artifact removal.The removal of IBI where done using  ‘rmoutliers’ MATLAB function. 

At this point there were no significant difference between beat intervals.

```{r, echo=FALSE, warning=FALSE, fig.align = "center"}
output_anova2 = ezANOVA(data = tsvr2,
                       dv = IBI,
                       wid = ptcp,
                       within = .(stimulus),
                       within_covariates = .(set),
                       detailed = T)
print(output_anova2)

ibig <- ezPlot(data = tsvr2,
               dv = IBI,
               wid = ptcp,
               within = .(stimulus),
               within_covariates = .(set),
               x = .(stimulus))
ibig = ibig +  labs(title ="IBI per Condition", x = "Visual - Heptic Stimuli", y = "(mean in seconds)") + 
  theme(
    panel.grid.major.y = element_line(colour = "gray80", size = NULL, linetype = NULL,  
                                      lineend = NULL)
    ,panel.grid.minor.y = element_line(colour = "gray90", size = NULL, linetype = NULL,
                                       lineend = NULL)
    ,panel.grid.major.x = element_blank()           
    ,panel.grid.minor.x = element_blank()
    ,legend.background = element_rect(fill = NULL, colour = "black") 
    
    ,panel.background = element_rect(fill = "white", colour = "white", size = NULL, 
                                     linetype = NULL)
  )
ibig
```

**4. Discussion**

a. There is a big dispersion in responses time. It might be better to restrict more the maximal answer condition from 6 to 5 seconds. 
b. There where 3 participants whos IBI wasn't considered because the MTEO algorithm. This needs to be yet adress. 
c. Meanwhile we are collecting 2 more participants. 
d. Check T R-peak distance? 
e. Compare change between preInteroceptive test x every condition (Meaning use the previous part of the experiment, where the participant sits to count HB) The idea is to see if the change respect the base is differentfor the conditions. 










